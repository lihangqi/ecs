# 使用快照创建自定义镜像 {#concept_gpg_t5l_xdb .concept}

自定义镜像是ECS实例系统盘某一时刻的快照。同时开通的云服务器ECS实例的配置既可以相同，也可以不同。示意图如下。

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/9696/4584_zh-CN.png)

您可以使用快照创建自定义镜像，将快照的操作系统、数据环境信息完整的包含在镜像中。然后使用自定义镜像创建多台具有相同操作系统和数据环境信息的实例，非常方便的复制实例。

您也可以使用实例创建镜像，请参考 [使用实例创建自定义镜像](intl.zh-CN/用户指南/镜像/创建自定义镜像/使用实例创建自定义镜像.md#)。

为了增加快照创建自定义镜像操作的安全性，请参考 [阿里云自定义镜像安全建议](https://www.alibabacloud.com/help/zh/faq-detail/54903.htm?spm=a2c63.q38357.a3.3.3a4b61feRLos9d)。

**说明：** 

-   创建的自定义镜像不能跨地域使用。
-   通过自定义镜像开通的ECS实例可以更换操作系统。更换系统后原来的自定义镜像还可以继续使用。请参见 [更换系统盘（非公共镜像）](intl.zh-CN/用户指南/云盘/更换系统盘（非公共镜像）.md#)。
-   使用自定义镜像开通的ECS实例可以升级CPU、内存、带宽、磁盘等。
-   自定义镜像功能不受付费模式限制，即不区分预付费和按量付费。预付费ECS实例的自定义镜像，可以用于开通按量付费的ECS实例；反之亦然。
-   用于创建自定义镜像的ECS实例到期或数据释放后（即用于快照的系统盘到期或释放），创建的自定义镜像不会受影响，使用自定义镜像开通的ECS实例也不会受影响。但自动快照则会随着ECS实例释放而被清除。

## Linux实例注意事项 {#section_tx3_vvl_xdb .section}

-   在使用Linux实例的系统盘创建自定义镜像时，不要在 /etc/fstab 文件中加载数据盘的信息，否则使用该镜像创建的实例无法启动。
-   强烈建议您在制作自定义镜像前 umount Linux实例上挂载的所有文件系统，然后再对系统盘打快照并创建自定义镜像，否则有可能造成以该自定义镜像创建的ECS实例不能启动或使用。
-   请勿随意升级内核或操作系统版本。
-   请勿调整系统盘分区。系统盘目前只支持单个根分区。
-   请检查系统盘使用剩余空间，确保系统盘没有被写满。
-   请勿修改关键系统文件，如 /sbin、/bin、/lib 目录等。
-   请勿修改默认登录用户名 root。

## 操作步骤 {#section_p1r_rwl_xdb .section}

1.  登录 [云服务器管理控制台](https://ecs.console.aliyun.com/#/home)。
2.  选择地域。
3.  在左侧导航栏里，单击 **实例**。
4.  找到目标实例，单击实例ID，或者在 **操作** 列，单击 **管理**。
5.  在左侧导航栏里，单击 **本实例快照**。找到目标系统盘，在 **操作** 列，单击 **创建自定义镜像**。

    快照的磁盘属性必须是系统盘。数据盘不能用于创建自定义镜像。

    您也可以通过 **快照** \> **快照列表**，选择一个磁盘属性为系统盘的快照，再 **创建自定义镜像**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/9696/4593_zh-CN.png)

6.  在弹出的 创建自定义镜像 对话框中，完成以下操作：
    -   确认快照ID。
    -   指定自定义镜像的名称和描述。
    -   （可选）如果您希望在创建的镜像中同时包含数据盘的信息，应该选择 **添加数据盘快照**，并单击 **增加** 来添加数据盘。

        **说明：** 

        请将数据盘中的敏感数据删除之后再创建自定义镜像，避免数据安全隐患。

        如果快照ID为空，则该磁盘会作为空盘创建，默认容量为5 GiB。

        如果选择了快照，则磁盘容量为快照的容量。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/9696/4594_zh-CN.png)

7.  单击 **创建**。自定义镜像创建成功。您可以单击左侧导航中的 **镜像**，然后查看刚创建的镜像。

## Linux镜像FAQ {#section_jwm_ryl_xdb .section}

**如何 `umount` 和删除disk table里的数据？**

假设 /dev/hda5 已经挂载在 /mnt/hda5 上，用以下三条命令均可卸载挂载的文件系统：

```
umount /dev/hda5
umount /mnt/hda5
umount /dev/hda5 /mnt/hda5
```

`/etc/fstab` 是Linux下比较重要的配置文件，它包含了系统在启动时挂载文件系统和存储设备的详细信息。如果不想在实例启动时挂载指定分区，需要在这个文件里面删除对应的行，删除下述语句可以在启动的时候断开xvdb1：`/dev/xvdb1 /leejd ext4 defaults 0 0`。

**如何确认数据盘已经卸载，并可以开始创建自定义镜像？**

需要确认fstab文件里面对应的自动挂载数据盘分区语句行已经删除。

使用 mount 命令可以查看所有设备的挂载信息，请确认执行结果中不包含对应的数据盘分区信息。

**相关配置文件**

自定义远程连接端口的详细操作，请参见 服务器默认远程端口修改。

|配置文件|配置说明|修改该配置文件的风险|
|:---|:---|:---------|
|/etc/issue\*, /etc/\*-release, /etc/\*\_version|系统发行版信息配置文件|修改 /etc/issue\* 会导致系统发行版无法被正常识别，导致系统创建失败。|
|/boot/grub/menu.lst, /boot/grub/grub.conf|系统引导启动配置文件|修改 /boot/grub/menu.lst 会导致内核无法正确加载，导致系统无法启动。|
|/etc/fstab|系统启动挂载分区配置文件|修改该文件会导致异常分区无法被加载，导致系统无法启动。|
|/etc/shadow|系统密码相关配置文件|修改该文件为只读会导致无法修改密码文件，导致系统创建失败。|
|/etc/selinux/config|系统安全策略配置文件|修改 /etc/selinux/config 开启SELinux导致系统无法启动。|

